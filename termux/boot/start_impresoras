#!/data/data/com.termux/files/usr/bin/bash
# Autostart simple para servicio de impresoras

PROJECT_DIR="$HOME/impresoras_pos"
LOG_FILE="$PROJECT_DIR/logs/autostart.log"

# Crear directorio de logs
mkdir -p "$PROJECT_DIR/logs"

# FunciÃ³n de log
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" >> "$LOG_FILE"
}

log "ğŸš€ Iniciando autostart..."

# Iniciar SSH
log "ğŸ” Iniciando SSH..."
sshd 2>/dev/null

# Esperar un poco para estabilizaciÃ³n
sleep 30

# Verificar conectividad bÃ¡sica
log "ğŸŒ Verificando red..."
for i in {1..10}; do
    if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
        log "âœ… Red OK"
        break
    fi
    log "â³ Esperando red... $i/10"
    sleep 10
done

# Limpiar sesiones screen anteriores
if screen -list | grep -q "impresoras"; then
    log "ğŸ§¹ Limpiando sesiÃ³n screen anterior..."
    screen -S impresoras -X quit 2>/dev/null
    sleep 3
fi

# Iniciar servicio en screen con monitor
log "ğŸ–¨ï¸  Iniciando servicio con monitor..."
screen -S impresoras -d -m bash -c "
    cd '$PROJECT_DIR' || exit 1
    echo \"\$(date): Monitor iniciado\" >> logs/autostart.log
    ./start_service.sh monitor
"

# Verificar que se iniciÃ³
sleep 5
if screen -list | grep -q "impresoras"; then
    log "âœ… Servicio iniciado en screen"

    # Verificar que el servicio interno estÃ¡ corriendo
    cd "$PROJECT_DIR"
    if ./start_service.sh status >/dev/null 2>&1; then
        log "âœ… Servicio confirmado activo"
    else
        log "âš ï¸  Servicio en screen pero no confirmado"
    fi
else
    log "âŒ Error: No se pudo crear sesiÃ³n screen"
fi

log "ğŸ Autostart completado"

# Si se ejecuta manualmente, mostrar info
if [ -t 1 ]; then
    echo "ğŸ–¨ï¸  Autostart completado"
    echo "ğŸ“Š Verificar: screen -r impresoras"
    echo "ğŸ“‹ Estado: cd ~/impresoras_pos && ./start_service.sh status"
    echo "ğŸ“ Logs: tail -f ~/impresoras_pos/logs/autostart.log"
fi